
#Parameters
region=eastus2
rg=lab2-svh-avs # set your Resource Group
vwanname=svh-avs # vWAN name
hubname1=svhub
hubname2=hub2
username=azureuser # Username
password="Msft123Msft123" # Please change your password
vmsize=Standard_DS1_v2 # VM Size

#NVA specific variables:
# Deploy BGP endpoint (Make the changes based on your needs)
nvavnetnamer1=spoke1 #Target NET
asn_frr=65002 # Set ASN
instances=2 #Set number of NVA instaces to be created
nvaintname=linux-nva #NVA instance name
nvasubnetname=nvasubnet #Existing Subnet where NVA gets deployed
hubtopeer=$hubname2 #Note: VNET has to be connected to the same hub
hubtoremove=$hubname1
nvanames=$(i=1;while [ $i -le $instances ];do echo $nvavnetnamer1-$nvaintname$i; ((i++));done)

# Remove spoke1 vnet connection from $hubname1
az network vhub connection delete --resource-group $rg --vhub-name $hubname1 --name spoke2conn --yes --no-wait
az network vhub connection delete --resource-group $rg --vhub-name $hubname1 --name spoke3conn --yes --no-wait

# Get spoke1-linux-nva-ilb private ip as variable
spoke1lbpip=$(az network lb show -g $rg -n spoke1-linux-nva-ilb --query frontendIPConfigurations[0].privateIPAddress -o tsv)

# Create UDR spokes-to-nva
az network route-table create -g $rg --name spokes-to-nva --location $region -o none
# Add route to UDR spokes-to-nva
az network route-table route create -g $rg --route-table spokes-to-nva --name default --address-prefix 0.0.0.0/0 --next-hop-type VirtualAppliance --next-hop-ip-address $spoke1lbpip -o none

# Associate UDR to spoke2 and spoke 3 main subnets
az network vnet subnet update -g $rg --vnet-name spoke2 -n main --route-table spokes-to-nva -o none
az network vnet subnet update -g $rg --vnet-name spoke3 -n main --route-table spokes-to-nva -o none

# VNET Peer Spoke 2 and Spoke 3 to Spoke 1
az network vnet peering create -g $rg -n spoke2-to-spoke1 --vnet-name spoke2 --remote-vnet spoke1 --allow-vnet-access --allow-forwarded-traffic -o none
az network vnet peering create -g $rg -n spoke3-to-spoke1 --vnet-name spoke3 --remote-vnet spoke1 --allow-vnet-access --allow-forwarded-traffic -o none

# VNET peer Spoke 1 to Spoke 2 and Spoke 3
az network vnet peering create -g $rg -n spoke1-to-spoke2 --vnet-name spoke1 --remote-vnet spoke2 --allow-vnet-access --allow-forwarded-traffic -o none
az network vnet peering create -g $rg -n spoke1-to-spoke3 --vnet-name spoke1 --remote-vnet spoke3 --allow-vnet-access --allow-forwarded-traffic -o none

# Add Spoke 2 and Spoke 3 Address Prefixes on FFR
for nvaname in $nvanames
do
  az vm run-command invoke -g $rg -n $nvaname --command-id RunShellScript --no-wait -o none --scripts '
#!/bin/bash

vtysh <<EOF
configure terminal

# Change to router bgp mode
router bgp 65002

# Add new network entries
 address-family ipv4 unicast
  network 172.16.0.0/22
  network 172.16.2.0/24
  network 172.16.3.0/24
 exit-address-family

end
write memory
EOF
'
done
