# Parameters (make changes based on your requirements)
rg=lab-svh-avsdr2
vwanname=svh-avsdr #set vWAN name
hub1name=sechub1 #set Hub1 name
hub2name=sechub2 #set Hub2 name
region1=$(az network vhub show -n $hub1name -g $rg --query location -o tsv)
region2=$(az network vhub show -n $hub2name -g $rg --query location -o tsv)

#ExpressRoute specific variables
ername1="er-ckt-$hub1name"
ername2="er-avs-$hub1name" 
ername3="er-ckt-$hub2name"
ername4="er-avs-$hub2name" 

# Dump ExpressRoute Circuit routes
echo "***** On-prem ER Circuit Routes *****" && \
az network express-route list-route-tables --path primary -n $ername1 -g $rg  --peering-name AzurePrivatePeering --query value -o table --only-show-errors && \
echo "***** AVS Prod ER Circuit Routes *****" && \
az network express-route list-route-tables --path primary -n $ername2 -g $rg  --peering-name AzurePrivatePeering --query value -o table --only-show-errors && \
echo "***** AVS DR ER Circuit Routes *****" && \
az network express-route list-route-tables --path primary -n $ername4 -g $rg  --peering-name AzurePrivatePeering --query value -o table --only-show-errors

# Dump effective routes from the Azure Firewall:
for vhubname in `az network vhub list -g $rg --query "[].name" -o tsv | sort -n`
do
   echo -e vHUB: $vhubname 
   echo -e Effective route table: $(echo $(az network firewall list -g $rg --query "[?contains(name,'$vhubname')].name" -o tsv))   
   az network vhub get-effective-routes -g $rg -n $vhubname \
   --resource-type AzureFirewalls \
   --resource-id $(az network firewall list -g $rg --query "[?contains(name,'$vhubname')].id" -o tsv) \
   --query "value[].{addressPrefixes:addressPrefixes[0], asPath:asPath, nextHopType:nextHopType}" \
   --output table
   echo
done

# SSH Spoke1vm to Spoke2vm
ssh azureuser@20.127.9.198

# remove Global Reach from er-ckt-sechub1
az network express-route update -n $ername1 -g $rg --set allowGlobalReach=false

az network connection 

# remove Global Reach from er-ckt-sechub2
az network express-route update -n $ername3 -g $rg --set allowGlobalReach=false


az network express-route peering connection create -g $rg --circuit-name $ername2 --peering-name AzurePrivatePeering -n AVS-to-Onprem --address-prefix 10.200.0.0/29 --peer-circuit 

az network express-route peering connection delete -g $rg --circuit-name $ername1 --peering-name AzurePrivatePeering -n AVS-to-Onprem 

az network express-route peering connection create -g $rg --circuit-name $ername2 --peering-name AzurePrivatePeering -n AVS-to-Onprem --peer-circuit /subscriptions/78216abe-8139-4b45-8715-6bab2010101e/resourceGroups/lab-svh-avsdr/providers/Microsoft.Network/expressRouteCircuits/er-ckt-sechub1/peerings/AzurePrivatePeering --address-prefix 10.200.0.0/29 


az network express-route peering update --remove -g $rg --circuit-name $ername1 


# Connectivity test
nc -z -v 10.154.0.2 22
nc -z -v 10.10.0.2 22
nc -z -v 10.20.0.2 22
